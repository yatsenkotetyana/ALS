---
title: "ALS_initial_research"
author: "Tetyana Yatsenko"
date: "2023-03-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

if(!require(dplyr)) install.packages("dplyr")
if(!require(ggplot2)) install.packages("ggplot2")
if(!require(xtable)) install.packages("xtable")
if(!require(devtools)) install.packages("devtools")

library(dplyr)
library(devtools)
library(ggplot2)
library(xtable)
```

## Read ALS Data


```{r}

workdir <- getwd() 

finenameALSFRS <- "PROACT_ALSFRS.csv"
finenameDeath <- "PROACT_DEATHDATA.csv"
finenameRiluzole <- "PROACT_RILUZOLE.csv"


alsrfs <-  read.csv(file = paste(workdir,finenameALSFRS,sep="/"))
alsrfs$subject_id <- as.factor(alsrfs$subject_id)
print(str(alsrfs))

deathdata <-  read.csv(file = paste(workdir,finenameDeath,sep="/"))
deathdata$subject_id <- as.factor(deathdata$subject_id)
print(str(deathdata))

riluzole <-  read.csv(file = paste(workdir,finenameRiluzole,sep="/"))
riluzole$subject_id <- as.factor(riluzole$subject_id)
print(str(riluzole))



impotantcolumns1 <- c("subject_id","ALSFRS_Delta","ALSFRS_R_Total")
impotantcolumns2 <- c("subject_id","ALSFRS_Delta","avg_ALSFRS_R_Total")
```

## Death Data
```{r}

# subject_id is not unique here. 
# it is one person with two death date, i will choose the last
filter_deathdata <- 
  deathdata  %>% 
  unique() %>%
  group_by(subject_id,Subject_Died) %>%
  summarise(Death_Days_max = max(Death_Days)) %>%
  ungroup()

colnames(filter_deathdata)[colnames(filter_deathdata) == "Death_Days_max"] = "Death_Days"



print(str(filter_deathdata))  

```

## Riluzole  Data
```{r}
# subject_id is unique here. I have checked
filter_riluzole <- 
  riluzole  %>% 
  unique() 

print(str(filter_riluzole))


```

## ALSRFRS  Data
```{r}

# select columns "subject_id","ALSFRS_Delta","ALSFRS_R_Total"
# filter rows with values in columns "ALSFRS_Delta","ALSFRS_R_Total"
# average value of "ALSFRS_R_Total" in a certain in moment of time
# we have several records some time


filter_alsrfs <- 
     alsrfs %>% 
     select(impotantcolumns1) %>% 
     filter(!is.na(ALSFRS_R_Total)) %>%
     filter(!is.na(ALSFRS_Delta))  %>%
     group_by(subject_id, ALSFRS_Delta) %>%
     summarise(avg_ALSFRS_R_Total = mean(ALSFRS_R_Total)) %>%
     select(impotantcolumns2) %>%
     ungroup() 
    

colnames(filter_alsrfs)[colnames(filter_alsrfs) == "avg_ALSFRS_R_Total"] = "ALSFRS_R_Total"
filter_alsrfs$ALSFRS_R_Total <- round( filter_alsrfs$ALSFRS_R_Total )

print(str(filter_alsrfs))

```

## Original statistics preparation
```{r}
# Calculate simple statistics: number of measurement (visits), day of first visit, last visit
# time between first and last visit days, weeks, months
stat_filter_alsrfs <- 
   filter_alsrfs %>%
   group_by(subject_id) %>%
   summarise( Number_visits = n(), 
              first_visit = min(ALSFRS_Delta), 
              last_visit = max(ALSFRS_Delta), 
              time_interval_days = 1+max(ALSFRS_Delta) - min(ALSFRS_Delta) ) 


stat_filter_alsrfs$first_visit_weeks <- round( stat_filter_alsrfs$first_visit / 7.0 )
stat_filter_alsrfs$first_visit_months <- round( stat_filter_alsrfs$first_visit / 30.0 )

stat_filter_alsrfs$last_visit_weeks <- round( stat_filter_alsrfs$last_visit / 7.0 )
stat_filter_alsrfs$last_visit_months <- round( stat_filter_alsrfs$last_visit / 30.0 )

stat_filter_alsrfs$time_interval_weeks <- round( stat_filter_alsrfs$time_interval_days / 7.0 )
stat_filter_alsrfs$time_interval_months <- round( stat_filter_alsrfs$time_interval_days / 30.0 )


# Add value of ALSFRS_R in the first measurement
stat_filter_alsrfs <- 
     stat_filter_alsrfs  %>%
     inner_join(filter_alsrfs, by=c("subject_id" = "subject_id", "first_visit" =  "ALSFRS_Delta")) %>%
     unique()
   
colnames(stat_filter_alsrfs)[colnames(stat_filter_alsrfs) == "ALSFRS_R_Total"] = "intial_ALSFRS_R_Total"

# Add value of ALSFRS_R in the last measurement
stat_filter_alsrfs <- 
     stat_filter_alsrfs  %>%
     inner_join(filter_alsrfs, by=c("subject_id" = "subject_id", "last_visit" =  "ALSFRS_Delta")) %>%
     unique()

colnames(stat_filter_alsrfs)[colnames(stat_filter_alsrfs) == "ALSFRS_R_Total"] = "last_ALSFRS_R_Total"

print(str(stat_filter_alsrfs))


```
## Merge death 
```{r}
stat_filter_alsrfs <-
  stat_filter_alsrfs  %>%
  left_join(filter_deathdata, by=c("subject_id" = "subject_id"))

stat_filter_alsrfs$Subject_Died[is.na(stat_filter_alsrfs$Subject_Died)] <- "No"

# Add   censored time of death,days (near 275 cases)
stat_filter_alsrfs$Death_Days[ stat_filter_alsrfs$Subject_Died=="Yes" & 
                              is.na(stat_filter_alsrfs$Death_Days) ] <- 
  stat_filter_alsrfs$last_visit[ stat_filter_alsrfs$Subject_Died=="Yes" & 
                              is.na(stat_filter_alsrfs$Death_Days) ]

# Death time weeks, months
stat_filter_alsrfs$Death_weeks <- round( stat_filter_alsrfs$Death_Days / 7.0 )
stat_filter_alsrfs$Death_months <- round(stat_filter_alsrfs$Death_Days / 30.0 )

print(str(stat_filter_alsrfs))

```
## Merge riluzole data
```{r}
stat_filter_alsrfs <-
  stat_filter_alsrfs  %>%
  left_join(filter_riluzole, by=c("subject_id" = "subject_id"))

stat_filter_alsrfs$Subject_used_Riluzole[is.na(stat_filter_alsrfs$Subject_used_Riluzole)] <- "No"
# Add start time of using Riluzole, for "Not" and "yes" without start time
stat_filter_alsrfs$Riluzole_use_Delta[is.na(stat_filter_alsrfs$Riluzole_use_Delta)] <- 0

stat_filter_alsrfs$Riluzole_use_Delta_weeks <- 
  round( stat_filter_alsrfs$Riluzole_use_Delta / 7.0 )
stat_filter_alsrfs$Riluzole_use_Delta_months <- 
  round( stat_filter_alsrfs$Riluzole_use_Delta / 30.0 )

print(str(stat_filter_alsrfs))

```
## Degradation, Slope
```{r}
# Changing of ALSFRS_R during all time
stat_filter_alsrfs$degradation <- stat_filter_alsrfs$last_ALSFRS_R_Total - stat_filter_alsrfs$intial_ALSFRS_R_Total

#More than one measurement + more than 1 month
stat_filter_alsrfs_op <- 
  stat_filter_alsrfs %>%
  filter(Number_visits>1) %>%
  filter(time_interval_months>0)
  

# Slope  of changing of ALSFRS_R during all time
stat_filter_alsrfs_op$slopedegradation <- 
  stat_filter_alsrfs_op$degradation / stat_filter_alsrfs_op$time_interval_months


filter_alsrfs <- 
  filter_alsrfs %>%
  mutate(ALSFRS_Delta_weeks = ALSFRS_Delta / 7.0) 
filter_alsrfs$ALSFRS_Delta_weeks <- round( filter_alsrfs$ALSFRS_Delta_weeks )

filter_alsrfs_st <-
  filter_alsrfs %>%
  inner_join(stat_filter_alsrfs, by=c("subject_id" = "subject_id")) 


filter_alsrfs_stop <-
  filter_alsrfs %>%
  inner_join(stat_filter_alsrfs_op, by=c("subject_id" = "subject_id")) 

print(str(stat_filter_alsrfs))
print(str(stat_filter_alsrfs_op))
print(str(filter_alsrfs_st))
print(str(filter_alsrfs_stop))
```

## Correlation xtable

```{r}

col <- c("Number_visits","time_interval_months","intial_ALSFRS_R_Total","last_ALSFRS_R_Total",
         "degradation","slopedegradation","Death_months", "Riluzole_use_Delta_months")

stat <- 
  filter_alsrfs_stop %>%
  select(col)

print(str(stat_correlation))

stat_correlation  <- cor(stat, use = "complete.obs")

print(stat_correlation)

```

## Histogram: Number of measurement 

```{r pressure, echo=FALSE}

p1 <- ggplot(stat_filter_alsrfs, aes(x = Number_visits)) + 
  geom_histogram(color="blue", fill="lightblue", binwidth=1) +
  geom_vline(aes(xintercept=mean(Number_visits)),  color="black", linetype="dashed", linewidth=1)+
  geom_vline(aes(xintercept=median(Number_visits)),  color="red", linetype="dashed", linewidth=1)


p2 <- ggplot(stat_filter_alsrfs, aes(x = Number_visits)) + 
  geom_histogram(aes(y=after_stat(density)), color="blue", fill="lightblue", binwidth=1)+
  geom_density(alpha=.2, fill="#FF6666") 

p3 <- p1 + facet_grid(Subject_Died~Subject_used_Riluzole, margins = TRUE, scales='free', labeller=label_both)
p4 <- p2 + facet_grid(Subject_Died~Subject_used_Riluzole, margins = TRUE, scales='free', labeller=label_both)


show(p1)
show(p2)
show(p3)
show(p4)


```

## Histogram: Initial ALSFRS_R
```{r pressure, echo=FALSE}

p1 <- ggplot(stat_filter_alsrfs, aes(x = intial_ALSFRS_R_Total)) + 
  geom_histogram(color="blue", fill="lightblue", binwidth=1) +
    geom_vline(aes(xintercept=mean(intial_ALSFRS_R_Total)),  color="black", linetype="dashed", linewidth=1) +
  geom_vline(aes(xintercept=median(intial_ALSFRS_R_Total)),  color="red", linetype="dashed", linewidth=1)


p2<- ggplot(stat_filter_alsrfs, aes(x =intial_ALSFRS_R_Total)) + 
  geom_histogram(aes(y=after_stat(density)), color="blue", fill="lightblue", binwidth=1)+
  geom_density(alpha=.2, fill="#FF6666") 

p3 <- p1 + facet_grid(Subject_Died~Subject_used_Riluzole, margins = TRUE, scales='free', labeller=label_both)
p4 <- p2 + facet_grid(Subject_Died~Subject_used_Riluzole, margins = TRUE, scales='free', labeller=label_both)


show(p1)
show(p2)
show(p3)
show(p4)

```
## Histogram: last ALSFRS_R
```{r pressure, echo=FALSE}

p1 <- ggplot(stat_filter_alsrfs, aes(x = last_ALSFRS_R_Total)) + 
  geom_histogram(color="blue", fill="lightblue", binwidth=1) +
    geom_vline(aes(xintercept=mean(last_ALSFRS_R_Total)),  color="black", linetype="dashed", linewidth=1) +
  geom_vline(aes(xintercept=median(last_ALSFRS_R_Total)),  color="red", linetype="dashed", linewidth=1)


p2 <- ggplot(stat_filter_alsrfs, aes(x =last_ALSFRS_R_Total)) + 
  geom_histogram(aes(y=after_stat(density)), color="blue", fill="lightblue", binwidth=1)+
  geom_density(alpha=.2, fill="#FF6666") 

p3 <- p1 + facet_grid(Subject_Died~Subject_used_Riluzole, margins = TRUE, scales='free', labeller=label_both)
p4 <- p2 + facet_grid(Subject_Died~Subject_used_Riluzole, margins = TRUE, scales='free', labeller=label_both)


show(p1)
show(p2)
show(p3)
show(p4)

```
## Histogram: degradation ALSFRS_R
```{r pressure, echo=FALSE}

p1 <- ggplot(stat_filter_alsrfs, aes(x = degradation)) + 
  geom_histogram(color="blue", fill="lightblue", binwidth=1) +
    geom_vline(aes(xintercept=mean(degradation)),  color="black", linetype="dashed", linewidth=1) +
  geom_vline(aes(xintercept=median(degradation)),  color="red", linetype="dashed", linewidth=1)


p2 <- ggplot(stat_filter_alsrfs, aes(x =degradation)) + 
  geom_histogram(aes(y=after_stat(density)), color="blue", fill="lightblue", binwidth=1)+
  geom_density(alpha=.2, fill="#FF6666") 

p3 <- p1 + facet_grid(Subject_Died~Subject_used_Riluzole, margins = TRUE, scales='free', labeller=label_both)
p4 <- p2 + facet_grid(Subject_Died~Subject_used_Riluzole, margins = TRUE, scales='free', labeller=label_both)


show(p1)
show(p2)
show(p3)
show(p4)

```

## Histogram: degradation ALSFRS_R (for more that one measurement) 
```{r pressure, echo=FALSE}

p1 <- ggplot(stat_filter_alsrfs_op, aes(x = degradation)) + 
  geom_histogram(color="blue", fill="lightblue", binwidth=1) +
    geom_vline(aes(xintercept=mean(degradation)),  color="black", linetype="dashed", linewidth=1) +
  geom_vline(aes(xintercept=median(degradation)),  color="red", linetype="dashed", linewidth=1)


p2 <- ggplot(stat_filter_alsrfs_op, aes(x =degradation)) + 
  geom_histogram(aes(y=after_stat(density)), color="blue", fill="lightblue", binwidth=1)+
  geom_density(alpha=.2, fill="#FF6666") 

p3 <- p1 + facet_grid(Subject_Died~Subject_used_Riluzole, margins = TRUE, scales='free', labeller=label_both)
p4 <- p2 + facet_grid(Subject_Died~Subject_used_Riluzole, margins = TRUE, scales='free', labeller=label_both)


show(p1)
show(p2)
show(p3)
show(p4)

```

## Histogram: slope degradation ALSFRS_R (for more that one measurement) 
```{r pressure, echo=FALSE}

p1 <- ggplot(stat_filter_alsrfs_op, aes(x = slopedegradation)) + 
  geom_histogram(color="blue", fill="lightblue", binwidth=0.25) +
    geom_vline(aes(xintercept=mean(slopedegradation)),  color="black", linetype="dashed", linewidth=1) +
  geom_vline(aes(xintercept=median(slopedegradation)),  color="red", linetype="dashed", linewidth=1)


p2 <- ggplot(stat_filter_alsrfs_op, aes(x = slopedegradation)) + 
  geom_histogram(aes(y=after_stat(density)), color="blue", fill="lightblue", binwidth=0.25)+
  geom_density(alpha=.2, fill="#FF6666") 

p3 <- p1 + facet_grid(Subject_Died~Subject_used_Riluzole, margins = TRUE, scales='free', labeller=label_both)
p4 <- p2 + facet_grid(Subject_Died~Subject_used_Riluzole, margins = TRUE, scales='free', labeller=label_both)


show(p1)
show(p2)
show(p3)
show(p4)

```
## Number of measurements depends on time interval (months)
```{r pressure, echo=FALSE}

p1 <- ggplot(stat_filter_alsrfs, aes(x = Number_visits, y = time_interval_months)) +
  geom_point(size=2,aes(color = Number_visits))

p3 <- p1 + facet_grid(Subject_Died~Subject_used_Riluzole, margins = TRUE, scales='free', labeller=label_both)

show(p1)
show(p3)


```
## Initial ALFRS_R depends on time interval (months)
```{r pressure, echo=FALSE}

p1 <- ggplot(stat_filter_alsrfs, aes(x = intial_ALSFRS_R_Total, y = time_interval_months)) +
  geom_point(size=2,aes(color = intial_ALSFRS_R_Total))

p3 <- p1 + facet_grid(Subject_Died~Subject_used_Riluzole, margins = TRUE, scales='free', labeller=label_both)

show(p1)
show(p3)


```
## Last ALFRS_R depends on time interval (months)
```{r pressure, echo=FALSE}

p1 <- ggplot(stat_filter_alsrfs, aes(x = last_ALSFRS_R_Total, y = time_interval_months)) +
  geom_point(size=2,aes(color = last_ALSFRS_R_Total))

p3 <- p1 + facet_grid(Subject_Died~Subject_used_Riluzole, margins = TRUE, scales='free', labeller=label_both)

show(p1)
show(p3)


```
## degradatio ALFRS_R depends on time interval (months)
```{r pressure, echo=FALSE}

p1 <- ggplot(stat_filter_alsrfs_op, aes(x = degradation, y = time_interval_months)) +
  geom_point(size=2,aes(color = degradation))

p3 <- p1 + facet_grid(Subject_Died~Subject_used_Riluzole, margins = TRUE, scales='free', labeller=label_both)

show(p1)
show(p3)


```
## scope degradation ALFRS_R depends on time interval (months)
```{r pressure, echo=FALSE}

ggplot(stat_filter_alsrfs_op, aes(x = slopedegradation, y = time_interval_months)) +
  geom_point(size=2,aes(color = slopedegradation))

```
## initial & last  ALFRS_R depends on time interval (months)
```{r pressure, echo=FALSE}

p1 <- ggplot(stat_filter_alsrfs_op, aes(x = intial_ALSFRS_R_Total, y = last_ALSFRS_R_Total)) +
  geom_point(size=2,aes(color = intial_ALSFRS_R_Total))

p3 <- p1 + facet_grid(Subject_Died~Subject_used_Riluzole, margins = TRUE, scales='free', labeller=label_both)

show(p1)
show(p3)


```
## ALSFRS_R =48
```{r pressure, echo=FALSE}
d1 <- 
  filter_alsrfs_stop %>%
  filter(intial_ALSFRS_R_Total==48)

p1 <- ggplot(d1, aes(x = ALSFRS_Delta_weeks, y = ALSFRS_R_Total)) +
   geom_line(aes(color=subject_id))+
   geom_point(aes(color=subject_id))
p3 <- p1 + facet_grid(Subject_Died~Subject_used_Riluzole, margins = TRUE, scales='free', labeller=label_both)

show(p1)
show(p3)


```

## ALSFRS_R =47
```{r pressure, echo=FALSE}
d1 <- 
  filter_alsrfs_stop %>%
  filter(intial_ALSFRS_R_Total==47)

p1 <- ggplot(d1, aes(x = ALSFRS_Delta_weeks, y = ALSFRS_R_Total)) +
   geom_line(aes(color=subject_id))+
   geom_point(aes(color=subject_id))

p3 <- p1 + facet_grid(Subject_Died~Subject_used_Riluzole, margins = TRUE, scales='free', labeller=label_both)

show(p1)
show(p3)

```


## ALSFRS_R =46
```{r pressure, echo=FALSE}
d1 <- 
  filter_alsrfs_stop %>%
  filter(intial_ALSFRS_R_Total==46)

p1 <- ggplot(d1, aes(x = ALSFRS_Delta_weeks, y = ALSFRS_R_Total)) +
   geom_line(aes(color=subject_id))+
   geom_point(aes(color=subject_id))

p3 <- p1 + facet_grid(Subject_Died~Subject_used_Riluzole, margins = TRUE, scales='free', labeller=label_both)

show(p1)
show(p3)

```